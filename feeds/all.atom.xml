<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>network|automation</title><link href="https://cidrblock.github.io/" rel="alternate"></link><link href="https://cidrblock.github.io/feeds/all.atom.xml" rel="self"></link><id>https://cidrblock.github.io/</id><updated>2016-12-20T18:12:54-08:00</updated><entry><title></title><link href="https://cidrblock.github.io/.html" rel="alternate"></link><published>2016-12-20T18:12:54-08:00</published><updated>2016-12-20T18:12:54-08:00</updated><author><name>Bradley A. Thornton</name></author><id>tag:cidrblock.github.io,2016-12-20:/.html</id><summary type="html">&lt;p&gt;Build an Ansible playbook from scratch.&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is based on the the Ansible best practices documented here.
http://docs.ansible.com/ansible/playbooks_best_practices.html&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#! /bin/bash&lt;/span&gt;

&lt;span class="c1"&gt;# make a directory for roles`&lt;/span&gt;
mkdir roles

&lt;span class="c1"&gt;# make a directory for group variables&lt;/span&gt;
mkdir group_vars

&lt;span class="c1"&gt;# make a directory for all&lt;/span&gt;
mkdir group_vars/all

&lt;span class="c1"&gt;# add a vars file and add a variable to it&lt;/span&gt;
touch group_vars/all/vars.yml
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my_var: {{ vault_my_var }}&amp;#39;&lt;/span&gt; &amp;gt;&amp;gt; group_vars/all/vars.yml

&lt;span class="c1"&gt;# add a vault file, a vaiable and encrypt it&lt;/span&gt;
touch group_vars/all/vault.yml
&lt;span class="nb"&gt;echo&lt;/span&gt; vault_my_var: &lt;span class="m"&gt;12345&lt;/span&gt; &amp;gt;&amp;gt; group_vars/all/vault.yml
ansible-vault encrypt group_vars/all/vault.yml

&lt;span class="c1"&gt;# make a directory for host variables&lt;/span&gt;
mkdir host_vars

&lt;span class="c1"&gt;# if any custom modules, put them here       &lt;/span&gt;
mkdir library  

&lt;span class="c1"&gt;#if any custom filter plugins, put them here       &lt;/span&gt;
mkdir filter_plugins

&lt;span class="c1"&gt;#callback directory  &lt;/span&gt;
mkdir callback_plugins

&lt;span class="c1"&gt;#make a root file&lt;/span&gt;
touch site.yml

&lt;span class="c1"&gt;#add an ansible.cfg file    &lt;/span&gt;
touch ansible.cfg  

&lt;span class="c1"&gt;# add some basics to the ansible.cfg    &lt;/span&gt;
cat &amp;gt; ansible.cfg &lt;span class="s"&gt;&amp;lt;&amp;lt;EOL&lt;/span&gt;
&lt;span class="s"&gt;[defaults]&lt;/span&gt;
&lt;span class="s"&gt;callback_plugins = ./callback_plugins&lt;/span&gt;
&lt;span class="s"&gt;filter_plugins = ./filter_plugins&lt;/span&gt;
&lt;span class="s"&gt;vault_password_file = vault_pass.py&lt;/span&gt;
&lt;span class="s"&gt;log_path = ./log.txt&lt;/span&gt;
&lt;span class="s"&gt;EOL&lt;/span&gt;

&lt;span class="c1"&gt;# add the vault decryption script to get the vault password from an environment variables&lt;/span&gt;
cat &amp;gt; vault_pass.py &lt;span class="s"&gt;&amp;lt;&amp;lt;EOL&lt;/span&gt;
&lt;span class="s"&gt;!/usr/bin/python&lt;/span&gt;
&lt;span class="s"&gt;import os&lt;/span&gt;
&lt;span class="s"&gt;print os.environ.get(&amp;#39;ANSIBLE_VAULT_PASSWORD&amp;#39;)&lt;/span&gt;
&lt;span class="s"&gt;EOL&lt;/span&gt;

&lt;span class="nb"&gt;echo&lt;/span&gt; The value of environment variable ANSIBLE_VAULT_PASSWORD will be used to decrypt the vault.

&lt;span class="c1"&gt;# build a new role called default&lt;/span&gt;
ansible-galaxy init --init-path&lt;span class="o"&gt;=&lt;/span&gt;roles --offline --verbose default

&lt;span class="c1"&gt;# review what&amp;#39;s built&lt;/span&gt;
tree
&lt;/pre&gt;&lt;/div&gt;</content><category term="ansible"></category><category term="netdevops"></category></entry><entry><title>Keep a running change log in Ansible</title><link href="https://cidrblock.github.io/keep-a-running-change-log-in-ansible.html" rel="alternate"></link><published>2016-12-20T16:06:06-08:00</published><updated>2016-12-20T16:06:06-08:00</updated><author><name>Bradley A. Thornton</name></author><id>tag:cidrblock.github.io,2016-12-20:/keep-a-running-change-log-in-ansible.html</id><summary type="html">&lt;p&gt;Ever need a nice report of all proposed changes across all network devices when running in check mode? How about an after the fact changelog per device after the run.&lt;/p&gt;</summary><content type="html">&lt;p&gt;Ever need a nice report of all proposed changes across all network devices when running in check mode? How about an after the fact changelog per device after the run.&lt;/p&gt;
&lt;p&gt;In group_vars/all, you'll need a new variable to store all the changes through the playbook run:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# group_vars/all&lt;/span&gt;
&lt;span class="l l-Scalar l-Scalar-Plain"&gt;changes&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="p p-Indicator"&gt;[]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then, as you make changes, append the changes to the change variable:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Remediate the device ({{ os }})&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ios_config&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;host&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;{{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;inventory_hostname&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}&amp;quot;&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;authorize&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;yes&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;timeout&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;60&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;lines&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;{{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;base_config&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;+&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;users_remove&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;+&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;enable_remove&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}&amp;quot;&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;register&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;config_changes&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;notify&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;{{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;os&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;+&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;#39;_save_config&amp;#39;&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}&amp;quot;&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Append changes to log ({{ os }})&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set_fact&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;changes&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;{{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;changes&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;+&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;[&amp;#39;***&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;ROLE:&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;+&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;role_path|basename&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;+&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;***&amp;#39;]&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;+&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;config_changes[&amp;#39;updates&amp;#39;]&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}&amp;quot;&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;when&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;config_changes[&amp;#39;updates&amp;#39;] is defined&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Make a new role, called 'report' which can get run as the last role in the playbook:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;Show config changes for device&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;debug&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;msg=&amp;quot;{{ changes }}&amp;quot;&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;when&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;changes|length &amp;gt; 0&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;tags&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;report&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now at the end of the playbook, before the summary a nice per device report is created. The 'changes' var could also be written to a file.&lt;/p&gt;</content><category term="ansible"></category><category term="netdevops"></category><category term="check-mode"></category></entry></feed>