<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Keep a running change log in Ansible | codethenetwork: cognizance
</title>
  <link rel="canonical" href="https://cidrblock.github.io/keep-a-running-change-log-in-ansible.html">

  <link rel="alternate" type="application/atom+xml" href="https://cidrblock.github.io/feeds/all.atom.xml" title="Full Atom Feed">
  <link rel="alternate" type="application/atom+xml" href="https://cidrblock.github.io/feeds/ansible.atom.xml" title="Categories Atom Feed">


  <link rel="stylesheet" href="https://cidrblock.github.io/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cidrblock.github.io/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cidrblock.github.io/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="https://cidrblock.github.io/theme/css/style.css">


<meta name="description" content="Ever need a nice report of all proposed changes across all network devices when running in check mode? How about an after the fact changelog per device after the run.">
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1 class="title"><a href="https://cidrblock.github.io">codethenetwork: cognizance</a></h1>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>Keep a running change log in Ansible
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2016-12-20T16:06:06.064882-08:00">
        <i class="fa fa-clock-o"></i>
        Tue 20 December 2016
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="https://cidrblock.github.io/category/ansible.html">ansible</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="https://cidrblock.github.io/author/bradley-a-thornton.html">Bradley A. Thornton</a>      </li>
      <li class="list-inline-item">
        <i class="fa fa-files-o"></i>
        <a href="https://cidrblock.github.io/tag/ansible.html">#ansible</a>,         <a href="https://cidrblock.github.io/tag/netdevops.html">#netdevops</a>,         <a href="https://cidrblock.github.io/tag/check-mode.html">#check-mode</a>      </li>
    </ul>
  </header>
  <div class="content">
    <p>Ever need a nice report of all proposed changes across all network devices when running in check mode? How about an after the fact changelog per device after the run.</p>
<p>In group_vars/all, you'll need a new variable to store all the changes through the playbook run:</p>
<div class="highlight"><pre><span></span># group_vars/all
changes: []
</pre></div>


<p>Then, as you make changes, append the changes to the change variable:</p>
<div class="highlight"><pre><span></span><span class="x">- name: Remediate the device (</span><span class="cp">{{</span> <span class="nv">os</span> <span class="cp">}}</span><span class="x">)</span>
<span class="x">  ios_config:</span>
<span class="x">    host: &quot;</span><span class="cp">{{</span> <span class="nv">inventory_hostname</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">    authorize: yes</span>
<span class="x">    timeout: 60</span>
<span class="x">    lines: &quot;</span><span class="cp">{{</span> <span class="nv">base_config</span> <span class="o">+</span> <span class="nv">users_remove</span> <span class="o">+</span> <span class="nv">enable_remove</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">  register: config_changes</span>
<span class="x">  notify: &quot;</span><span class="cp">{{</span> <span class="nv">os</span> <span class="o">+</span> <span class="s1">&#39;_save_config&#39;</span> <span class="cp">}}</span><span class="x">&quot;</span>

<span class="x">- name: Append changes to log (</span><span class="cp">{{</span> <span class="nv">os</span> <span class="cp">}}</span><span class="x">)</span>
<span class="x">  set_fact:</span>
<span class="x">    changes: &quot;</span><span class="cp">{{</span> <span class="nv">changes</span> <span class="o">+</span> <span class="o">[</span><span class="s1">&#39;*** ROLE: &#39;</span> <span class="o">+</span> <span class="nv">role_path</span><span class="o">|</span><span class="nf">basename</span> <span class="o">+</span> <span class="s1">&#39; ***&#39;</span><span class="o">]</span> <span class="o">+</span> <span class="nv">config_changes</span><span class="o">[</span><span class="s1">&#39;updates&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">  when: config_changes[&#39;updates&#39;] is defined</span>
</pre></div>


<p>Make a new role, called 'report' which can get run as the last role in the playbook:</p>
<div class="highlight"><pre><span></span><span class="x">- name: Show config changes for device</span>
<span class="x">debug: msg=&quot;</span><span class="cp">{{</span> <span class="nv">changes</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">when: changes|length &gt; 0</span>
<span class="x">tags:</span>
<span class="x">- report</span>
</pre></div>


<p>Now at the end of the playbook, before the summary a nice per device report is created. The 'changes' var could also be written to a file.</p>
  </div>
</article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="https://cidrblock.github.io/authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="https://cidrblock.github.io/archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="https://cidrblock.github.io/categories.html">Categories</a></li>
          <li class="list-inline-item"><a href="https://cidrblock.github.io/tags.html">Tags</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a> / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>